import streamlit as st
import pandas as pd
import plotly.express as px

# 1. MBTI ìœ í˜•ë³„ ì„¤ëª… ë°ì´í„°
mbti_descriptions = {
    "INTJ": {"name": "ìš©ì˜ì£¼ë„í•œ ì „ëµê°€", "desc": "ì „ì²´ì ì¸ ê·¸ë¦¼ì„ ê·¸ë¦¬ë©° ì „ëµì„ ì„¸ìš°ëŠ” ê²ƒì„ ì¢‹ì•„í•©ë‹ˆë‹¤. ì§€ì  í˜¸ê¸°ì‹¬ì´ ë§ê³  ë…ë¦½ì ì´ë©°, ì™„ë²½ì£¼ì˜ì ì¸ ê²½í–¥ì´ ìˆìŠµë‹ˆë‹¤."},
    "INTP": {"name": "ì•„ì´ë””ì–´ ë±…í¬", "desc": "ì§€ì‹ì— ëŒ€í•œ ëì—†ëŠ” ê°ˆë§ì„ ê°€ì§„ ë…¼ë¦¬ì ì¸ ì‚¬ìƒ‰ê°€ì…ë‹ˆë‹¤. ë³µì¡í•œ ë¬¸ì œë¥¼ ë¶„ì„í•˜ê³  ìƒˆë¡œìš´ ì´ë¡ ì„ íƒêµ¬í•˜ëŠ” ê²ƒì„ ì¦ê¹ë‹ˆë‹¤."},
    "ENTJ": {"name": "ëŒ€ë‹´í•œ í†µì†”ì", "desc": "íƒ€ê³ ë‚œ ì§€ë„ìë¡œ, ëª©í‘œë¥¼ í–¥í•´ ì‚¬ëŒë“¤ì„ ì´ë„ëŠ” ë° ëŠ¥ìˆ™í•©ë‹ˆë‹¤. íš¨ìœ¨ì„±ê³¼ ì¡°ì§ë ¥ì„ ì¤‘ìš”ì‹œí•˜ë©° ì¹´ë¦¬ìŠ¤ë§ˆê°€ ë„˜ì¹©ë‹ˆë‹¤."},
    "ENTP": {"name": "ëœ¨ê±°ìš´ ë…¼ìŸì„ ì¦ê¸°ëŠ” ë³€ë¡ ê°€", "desc": "ì§€ì ì¸ ë„ì „ê³¼ ë…¼ìŸì„ ì¦ê¸°ë©°, ìƒˆë¡œìš´ ì•„ì´ë””ì–´ë¥¼ ëŠì„ì—†ì´ íƒìƒ‰í•©ë‹ˆë‹¤. ê¸°ë°œí•˜ê³  ì¬ì¹˜ìˆëŠ” ë°©ì‹ìœ¼ë¡œ ìƒí™©ì„ í•´ê²°í•©ë‹ˆë‹¤."},
    "INFJ": {"name": "ì„ ì˜ì˜ ì˜¹í˜¸ì", "desc": "ê¹Šì€ í†µì°°ë ¥ê³¼ ê°•í•œ ì‹ ë…ì„ ê°€ì§„ ì¡°ìš©í•˜ê³  ì‹ ë¹„ë¡œìš´ ì‚¬ëŒì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì‚¬ëŒë“¤ì˜ ì„±ì¥ê³¼ ë°œì „ì— ê¸°ì—¬í•˜ëŠ” ê²ƒì„ ì¤‘ìš”í•˜ê²Œ ìƒê°í•©ë‹ˆë‹¤."},
    "INFP": {"name": "ì—´ì •ì ì¸ ì¤‘ì¬ì", "desc": "ë‚´ë©´ì˜ ê°€ì¹˜ì™€ ì´ìƒì„ ì¶”êµ¬í•˜ëŠ” ì‚¬ë ¤ ê¹Šê³  ì˜¨í™”í•œ ì´ìƒì£¼ì˜ìì…ë‹ˆë‹¤. ìƒìƒë ¥ì´ í’ë¶€í•˜ê³  ì˜ˆìˆ ì ì¸ ê°ìˆ˜ì„±ì´ ë›°ì–´ë‚©ë‹ˆë‹¤."},
    "ENFJ": {"name": "ì •ì˜ë¡œìš´ ì‚¬íšŒìš´ë™ê°€", "desc": "ì‚¬ëŒë“¤ì˜ ì ì¬ë ¥ì„ ì´ëŒì–´ë‚´ëŠ” ë° ëŠ¥ìˆ™í•˜ë©°, ì‚¬íšŒ ì •ì˜ ì‹¤í˜„ì— ì•ì¥ì„­ë‹ˆë‹¤. ë”°ëœ»í•˜ê³  ì±…ì„ê°ì´ ê°•í•˜ë©° íƒ€ì¸ì—ê²Œ í—Œì‹ ì ì…ë‹ˆë‹¤."},
    "ENFP": {"name": "ì¬ê¸°ë°œë„í•œ í™œë™ê°€", "desc": "ë„˜ì¹˜ëŠ” ì—ë„ˆì§€ì™€ ìƒìƒë ¥ì„ ê°€ì§„ ììœ ë¡œìš´ ì˜í˜¼ì…ë‹ˆë‹¤. ìƒˆë¡œìš´ ê°€ëŠ¥ì„±ì„ íƒìƒ‰í•˜ë©° ì‚¬ëŒë“¤ê³¼ì˜ ê´€ê³„ë¥¼ í†µí•´ ì˜ê°ì„ ì–»ìŠµë‹ˆë‹¤."},
    "ISTJ": {"name": "ì²­ë ´ê²°ë°±í•œ ë…¼ë¦¬ì£¼ì˜ì", "desc": "ì‚¬ì‹¤ì— ì…ê°í•˜ì—¬ ë…¼ë¦¬ì ìœ¼ë¡œ ì‚¬ê³ í•˜ë©°, ì§ˆì„œì™€ ì „í†µì„ ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ëŠ” ì±…ì„ê° ìˆëŠ” í˜„ì‹¤ì£¼ì˜ìì…ë‹ˆë‹¤."},
    "ISFJ": {"name": "ìš©ê°í•œ ìˆ˜í˜¸ì", "desc": "ë”°ëœ»í•˜ê³  í—Œì‹ ì ì´ë©°, ì£¼ë³€ ì‚¬ëŒë“¤ì„ ë³´í˜¸í•˜ê³  ë•ëŠ” ë° ì—´ì‹¬ì…ë‹ˆë‹¤. ì¡°ìš©í•˜ì§€ë§Œ ê°•í•œ ì±…ì„ê°ê³¼ ì„±ì‹¤í•¨ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤."},
    "ESTJ": {"name": "ì—„ê²©í•œ ê´€ë¦¬ì", "desc": "ì²´ê³„ì ì´ê³  ì¡°ì§ì ì´ë©°, ê·œì¹™ê³¼ ì ˆì°¨ë¥¼ ì¤€ìˆ˜í•˜ëŠ” ë° ì² ì €í•©ë‹ˆë‹¤. í˜„ì‹¤ì ì´ê³  ì‹¤ìš©ì ì¸ ë¦¬ë”ì‹­ì„ ë°œíœ˜í•©ë‹ˆë‹¤."},
    "ESFJ": {"name": "ì‚¬êµì ì¸ ì™¸êµê´€", "desc": "ì‚¬ëŒë“¤ê³¼ì˜ ê´€ê³„ë¥¼ ì¤‘ìš”ì‹œí•˜ë©°, ì¹œì ˆí•˜ê³  ì‚¬êµì„±ì´ ì¢‹ìŠµë‹ˆë‹¤. ì£¼ë³€ ë¶„ìœ„ê¸°ë¥¼ ë°ê²Œ ë§Œë“¤ê³  í™”í•©ì„ ë„ëª¨í•˜ëŠ” ë° ëŠ¥ìˆ™í•©ë‹ˆë‹¤."},
    "ISTP": {"name": "ë§ŒëŠ¥ ì¬ì£¼ê¾¼", "desc": "í˜¸ê¸°ì‹¬ì´ ë§ê³  ì†ì¬ì£¼ê°€ ë›°ì–´ë‚˜ë©°, ì§ì ‘ ê²½í—˜í•˜ê³  ë°°ìš°ëŠ” ê²ƒì„ ì„ í˜¸í•©ë‹ˆë‹¤. ë¬¸ì œ í•´ê²° ëŠ¥ë ¥ì´ ë›°ì–´ë‚˜ê³  ë…ë¦½ì ì…ë‹ˆë‹¤."},
    "ISFP": {"name": "ììœ ë¡œìš´ ì˜í˜¼ì˜ ì—°ì˜ˆì¸", "desc": "ì˜ˆìˆ ì ì¸ ê°ìˆ˜ì„±ì´ ë›°ì–´ë‚˜ê³ , í˜„ì¬ë¥¼ ì¦ê¸°ë©° ì‚¶ì˜ ì•„ë¦„ë‹¤ì›€ì„ ì¶”êµ¬í•©ë‹ˆë‹¤. ê²¸ì†í•˜ê³  ìœ ì—°í•˜ë©° ìì‹ ì˜ ê°€ì¹˜ê´€ì„ ì¤‘ìš”í•˜ê²Œ ìƒê°í•©ë‹ˆë‹¤."},
    "ESTP": {"name": "ëª¨í—˜ì„ ì¦ê¸°ëŠ” ì‚¬ì—…ê°€", "desc": "í™œë™ì ì´ê³  í˜„ì‹¤ì ì´ë©°, ì¦‰í¥ì ì´ê³  ëŒ€ë‹´í•œ í–‰ë™ìœ¼ë¡œ ë¬¸ì œë¥¼ í•´ê²°í•©ë‹ˆë‹¤. ì‚¬ëŒë“¤ê³¼ ì–´ìš¸ë¦¬ëŠ” ê²ƒì„ ì¢‹ì•„í•˜ê³  ì—ë„ˆì§€ê°€ ë„˜ì¹©ë‹ˆë‹¤."},
    "ESFP": {"name": "ììœ ë¡œìš´ ì—°ì˜ˆì¸", "desc": "ì£¼ëª©ë°›ëŠ” ê²ƒì„ ì¦ê¸°ë©°, ë°ê³  ê¸ì •ì ì¸ ì—ë„ˆì§€ë¡œ ì£¼ë³€ì„ ì¦ê²ê²Œ í•©ë‹ˆë‹¤. ì‚¶ì„ ì¶•ì œì²˜ëŸ¼ ì¦ê¸°ëŠ” ë‚™ì²œì ì¸ ì„±í–¥ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤."},
}

# 2. ë°ì´í„° ë¡œë“œ ë° ì „ì²˜ë¦¬
try:
    df = pd.read_csv("countriesMBTI_16types.csv")
    df_melted = df.melt(id_vars=["Country"], 
                        var_name="MBTI", 
                        value_name="Proportion")
except FileNotFoundError:
    st.error("ğŸš¨ 'countriesMBTI_16types.csv' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
    df = pd.DataFrame() # ë¹ˆ ë°ì´í„°í”„ë ˆì„ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ì—ëŸ¬ ë°©ì§€


# 3. ìŠ¤íŠ¸ë¦¼ë¦¿ ì•± ì„¤ì •
st.set_page_config(
    page_title="MBTI ì„±í–¥ & êµ­ê°€ í†µê³„ ì›¹ì•±",
    layout="wide",
    initial_sidebar_state="expanded"
)

st.title("ğŸŒŸ MBTI ì„±í–¥ ë¶„ì„ ë° êµ­ê°€ë³„ í†µê³„ ì •ë³´")
st.markdown("---")


# 4. ì‚¬ì´ë“œë°” MBTI ì„ íƒ ìœ„ì ¯
with st.sidebar:
    st.header("ğŸ‘¤ MBTI ìœ í˜• ì„ íƒ")
    mbti_options = ["MBTIë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”"] + list(mbti_descriptions.keys())
    
    # ì„¸ì…˜ ìƒíƒœë¥¼ í™œìš©í•˜ì—¬ í˜„ì¬ ì„ íƒëœ MBTIë¥¼ ì €ì¥
    if 'selected_mbti' not in st.session_state:
        st.session_state.selected_mbti = mbti_options[0]
        
    # selectbox ìœ„ì ¯
    selected_mbti = st.selectbox(
        "ë‹¹ì‹ ì˜ MBTI ìœ í˜•ì„ ê³¨ë¼ë³´ì„¸ìš”:", 
        options=mbti_options,
        index=mbti_options.index(st.session_state.selected_mbti)
    )
    
    # ì„ íƒëœ ê°’ ì—…ë°ì´íŠ¸
    st.session_state.selected_mbti = selected_mbti
    
    st.markdown("---")
    st.info("ì´ ì•±ì€ ìŠ¤íŠ¸ë¦¼ë¦¿ê³¼ Plotlyë¥¼ ì‚¬ìš©í•˜ì—¬ ì œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.")


# 5. ë©”ì¸ ì½˜í…ì¸  í‘œì‹œ
if st.session_state.selected_mbti == "MBTIë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”":
    # 5-1. ì´ˆê¸° ì ‘ì† ë©”ì‹œì§€ (ìš”êµ¬ì‚¬í•­ 4)
    st.header("ğŸ‘‹ í™˜ì˜í•©ë‹ˆë‹¤!")
    st.markdown("""
        **ì™¼ìª½ ì‚¬ì´ë“œë°”**ì—ì„œ ë‹¹ì‹ ì˜ **MBTI ìœ í˜•**ì„ ì„ íƒí•´ì£¼ì„¸ìš”.
        
        ì„ íƒí•˜ì‹œë©´ í•´ë‹¹ MBTIì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª…ê³¼ 
        êµ­ê°€ë³„ í†µê³„ ì •ë³´ë¥¼ ë©‹ì§„ ê·¸ë˜í”„ë¡œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤!
        
        ---
    """)
    st.balloons() # ì´ˆê¸°ì— í’ì„  íš¨ê³¼ ì¶”ê°€
    
else:
    mbti = st.session_state.selected_mbti
    info = mbti_descriptions[mbti]
    
    st.header(f"âœ¨ ë‹¹ì‹ ì˜ MBTI: {mbti} ({info['name']})")
    
    # 5-2. MBTI ì„¤ëª… í‘œì‹œ (ìš”êµ¬ì‚¬í•­ 2)
    st.subheader("ğŸ’¡ ìœ í˜• ì„¤ëª…")
    st.markdown(f"> **{info['desc']}**")
    st.markdown("---")
    
    if not df.empty:
        st.subheader(f"ğŸŒ {mbti} ìœ í˜•ì˜ êµ­ê°€ë³„ í†µê³„ ë¶„ì„")
        
        # ì„ íƒëœ MBTI ë°ì´í„° í•„í„°ë§ ë° ìƒìœ„ 10ê°œ ì¶”ì¶œ
        mbti_df = df_melted[df_melted["MBTI"] == mbti].sort_values(by="Proportion", ascending=False)
        top_10_countries = mbti_df.head(10).copy()
        
        # ë¹„ìœ¨ì„ %ë¡œ ë³€í™˜
        top_10_countries["Proportion_pct"] = (top_10_countries["Proportion"] * 100).round(2)
        
        # 5-3. í†µê³„ ì •ë³´ ì‹œê°í™” (Plotly)
        fig = px.bar(
            top_10_countries,
            x="Country",
            y="Proportion_pct",
            text="Proportion_pct",
            title=f"**{mbti} ìœ í˜• ë¹„ìœ¨ì´ ë†’ì€ ìƒìœ„ 10ê°œ êµ­ê°€**",
            labels={"Proportion_pct": f"{mbti} ìœ í˜• ë¹„ìœ¨ (%)", "Country": "êµ­ê°€"},
            color="Proportion_pct",
            color_continuous_scale=px.colors.sequential.Plotly3,
        )
        
        fig.update_traces(texttemplate='%{text:.2f}%', textposition='outside')
        fig.update_layout(uniformtext_minsize=8, uniformtext_mode='hide')
        st.plotly_chart(fig, use_container_width=True)

        # 5-4. í†µê³„ ê¸°ë°˜ ë§ì¶¤ ë©˜íŠ¸ (ìš”êµ¬ì‚¬í•­ 3)
        st.subheader("ğŸ’¬ í†µê³„ ê¸°ë°˜ ë§ì¶¤ ë©˜íŠ¸")
        
        # ê°€ì¥ ë¹„ìœ¨ì´ ë†’ì€ êµ­ê°€ (1ìœ„)
        if not top_10_countries.empty:
            best_country = top_10_countries.iloc[0]
            ment_message = f"""
            ğŸ“Š í†µê³„ì ìœ¼ë¡œ **{mbti}** ìœ í˜•ì˜ ë¹„ìœ¨ì´ ê°€ì¥ ë†’ì€ êµ­ê°€ëŠ” **{best_country['Country']}** ì…ë‹ˆë‹¤. 
            í•´ë‹¹ êµ­ê°€ì—ì„œëŠ” ì „ì²´ ì¸êµ¬ ì¤‘ **{best_country['Proportion_pct']:.2f}%**ê°€ ë‹¹ì‹ ê³¼ ê°™ì€ ì„±í–¥ì„ ê°€ì§€ê³  ìˆë‹¤ê³  í•´ìš”! 
            ì´ëŠ” **{mbti}** ìœ í˜•ì˜ íŠ¹ì„±ì´ ì´ ë‚˜ë¼ì˜ ë¬¸í™”ë‚˜ ì‚¬íšŒì  í™˜ê²½ê³¼ ì–´ë– í•œ ë°©ì‹ìœ¼ë¡œë“  ê´€ë ¨ì´ ìˆì„ ìˆ˜ ìˆë‹¤ëŠ” í¥ë¯¸ë¡œìš´ ì§€í‘œì…ë‹ˆë‹¤. 
            ë‹¹ì‹ ì˜ ì„±í–¥ì´ ì´ëŒë¦¬ëŠ” ë¬¸í™”ê¶Œì¼ì§€ë„ ëª¨ë¥´ê² ë„¤ìš”!
            """
            st.success(ment_message)
        else:
            st.warning(f"ì£„ì†¡í•©ë‹ˆë‹¤. **{mbti}** ìœ í˜•ì— ëŒ€í•œ êµ­ê°€ë³„ í†µê³„ ì •ë³´ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
